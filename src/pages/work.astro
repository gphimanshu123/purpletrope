---
import Layout from '../layouts/Layout.astro';
import WorkShowcase, { type WorkImage, type WorkProject } from '../components/work/WorkShowcase';
import { loadSanityQuery } from '../lib/sanityClient';
import groq from 'groq';
import type { PageHeaderContent } from '../types/pageHeader';

export const prerender = true;

const workQuery = groq`*[_type == "work"] | order(coalesce(order, 9999) asc, _createdAt desc) {
  "id": _id,
  title,
  role,
  description,
  period,
  cmsOptions,
  images[]{
    ...,
    "url": asset->url
  }
}`;

const sanityProjects = await loadSanityQuery<WorkProject[]>(workQuery);
const pageHeaderQuery = groq`*[_type == "pageHeader" && page == "work"][0]{
  label,
  title,
  description
}`;
const pageHeader = await loadSanityQuery<Pick<PageHeaderContent, "label" | "title" | "description"> | null>(pageHeaderQuery);

const projects: WorkProject[] = (sanityProjects ?? []).map((project) => {
	const filteredBadges = project.cmsOptions?.filter((tag) => Boolean(tag && tag.trim()));
	const filteredImages = ((project.images ?? []) as WorkImage[]).filter((image) => Boolean(image));
	const trimmedRole = project.role?.trim();

	return {
		...project,
		role: trimmedRole ? trimmedRole : undefined,
		cmsOptions: filteredBadges,
		images: filteredImages.length > 0 ? filteredImages : undefined,
	};
});
---

<Layout title="Work Â· Debjani Portfolio">
	<WorkShowcase client:load projects={projects} header={pageHeader ?? undefined} />
</Layout>
